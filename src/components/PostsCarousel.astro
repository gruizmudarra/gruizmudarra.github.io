---
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import { randomUUID } from "node:crypto";

// Get all pinned blog posts
const pinnedPosts = await getCollection("blog", ({ data }) => {
    return data.pinned === true;
});

// Sort by publication date (newest first)
pinnedPosts.sort(
    (a, b) =>
        new Date(b.data.pubDate || 0).valueOf() -
        new Date(a.data.pubDate || 0).valueOf(),
);

const slidesPerViewLg = 3;
const carouselId = `posts-carousel-${randomUUID()}`;
const headingId = `${carouselId}-heading`;
const trackId = `${carouselId}-track`;
---

<section class="mb-12">
    <h2
        id={headingId}
        class="mb-6 text-center font-extrabold md:mb-12"
        data-carousel-heading
    >
        Posts Destacados
    </h2>

    {
        pinnedPosts.length > 0 ? (
            <div
                class="relative"
                role="region"
                aria-labelledby={headingId}
                data-carousel
                data-carousel-id={carouselId}
            >
                <div class="carousel-container overflow-hidden pt-8">
                    <div
                        class="carousel-track flex transition-transform duration-300 ease-in-out"
                        id={trackId}
                        data-carousel-track
                        aria-live="polite"
                    >
                        {pinnedPosts.map((post) => (
                            <div class="carousel-slide w-full flex-shrink-0 px-4 md:w-1/2 lg:w-1/3">
                                <a
                                    href={`/blog/${post.id}/`}
                                    class="group flex h-full flex-col overflow-hidden rounded-lg border border-gray-200 bg-white shadow-lg transition-all duration-300 hover:-translate-y-1 hover:shadow-xl focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-500"
                                    aria-label={`Leer mÃ¡s sobre ${post.data.title}`}
                                >
                                    <article class="flex h-full flex-col">
                                        {post.data.heroImage && (
                                            <div class="aspect-video overflow-hidden rounded-none">
                                                <Image
                                                    src={post.data.heroImage}
                                                    alt={post.data.title}
                                                    width={800}
                                                    height={450}
                                                    loading="lazy"
                                                    decoding="async"
                                                    class="h-full w-full rounded-none object-cover transition-transform duration-300 group-hover:scale-105"
                                                />
                                            </div>
                                        )}
                                        <div class="flex flex-grow flex-col p-4 text-left">
                                            <h3 class="title-clamp mb-2 font-bold text-gray-900">
                                                {post.data.title}
                                            </h3>
                                            <p class="description-clamp mb-2 flex-grow text-base leading-relaxed text-gray-600">
                                                {post.data.description}
                                            </p>
                                        </div>
                                    </article>
                                </a>
                            </div>
                        ))}
                    </div>
                </div>

                {pinnedPosts.length > slidesPerViewLg && (
                    <div class="mt-6 flex flex-wrap items-center justify-center gap-4">
                        <button
                            type="button"
                            class="rounded-full bg-gray-100 p-3 text-gray-700 shadow transition hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            aria-label="Anterior"
                            aria-controls={trackId}
                            data-carousel-prev
                        >
                            <svg
                                class="h-5 w-5"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M15 19l-7-7 7-7"
                                />
                            </svg>
                        </button>
                        <button
                            type="button"
                            class="rounded-full bg-gray-100 p-3 text-gray-700 shadow transition hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                            aria-label="Siguiente"
                            aria-controls={trackId}
                            data-carousel-next
                        >
                            <svg
                                class="h-5 w-5"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9 5l7 7-7 7"
                                />
                            </svg>
                        </button>
                    </div>
                )}
            </div>
        ) : (
            <div class="py-12 text-center text-gray-500">
                <p class="text-lg">No hay posts destacados disponibles.</p>
            </div>
        )
    }
</section>

<style>
    :global(h2[data-carousel-heading]) {
        font-size: clamp(2.5rem, 4vw, 3.25rem);
        line-height: 1.2;
        letter-spacing: -0.01em;
    }

    :global([data-carousel] h3.title-clamp) {
        margin-top: 1rem;
        font-size: 1.35rem;
        line-height: 1.9rem;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
        text-overflow: ellipsis;
        max-height: 3.8rem; /* 2 lines */
    }

    :global([data-carousel] img) {
        border-radius: 0;
    }

    :global([data-carousel] p.description-clamp) {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 3;
        overflow: hidden;
        text-overflow: ellipsis;
    }
</style>

<script type="module">
    (() => {
        const carouselSelector = "[data-carousel]";
        const readyAttr = "data-carousel-ready";

        const getSlidesPerView = () => {
            if (window.innerWidth >= 1024) return 3;
            if (window.innerWidth >= 768) return 2;
            return 1;
        };

        const initCarousel = (carousel) => {
            const track = carousel.querySelector("[data-carousel-track]");
            const prevBtn = carousel.querySelector("[data-carousel-prev]");
            const nextBtn = carousel.querySelector("[data-carousel-next]");
            const slides = track ? Array.from(track.children) : [];

            if (!track || slides.length === 0) return;

            const totalSlides = slides.length;
            let currentIndex = 0;
            let autoPlayInterval;
            let touchStartX = 0;
            let touchStartY = 0;
            let isDragging = false;

            const maxIndex = () =>
                Math.max(0, totalSlides - getSlidesPerView());

            const updateCarousel = () => {
                const slideWidth =
                    slides[0]?.getBoundingClientRect().width ?? 0;
                currentIndex = Math.max(0, Math.min(currentIndex, maxIndex()));
                if (slideWidth > 0) {
                    track.style.transform = `translateX(-${
                        currentIndex * slideWidth
                    }px)`;
                }
            };

            const goToSlide = (index) => {
                const limit = maxIndex();
                if (index > limit) {
                    currentIndex = 0;
                } else if (index < 0) {
                    currentIndex = limit;
                } else {
                    currentIndex = index;
                }
                updateCarousel();
            };

            const shouldAutoPlay = () => totalSlides > getSlidesPerView();

            const stopAutoPlay = () => {
                if (autoPlayInterval) {
                    clearInterval(autoPlayInterval);
                    autoPlayInterval = undefined;
                }
            };

            const startAutoPlay = () => {
                if (!shouldAutoPlay()) {
                    stopAutoPlay();
                    return;
                }
                stopAutoPlay();
                autoPlayInterval = window.setInterval(() => {
                    const limit = maxIndex();
                    if (limit === 0) return;
                    goToSlide(currentIndex >= limit ? 0 : currentIndex + 1);
                }, 5000);
            };

            const handleManualNav = (nextIndex) => {
                goToSlide(nextIndex);
                startAutoPlay();
            };

            prevBtn?.addEventListener("click", () =>
                handleManualNav(currentIndex - 1),
            );
            nextBtn?.addEventListener("click", () =>
                handleManualNav(currentIndex + 1),
            );

            const handleKeydown = (event) => {
                if (event.key === "ArrowLeft" || event.key === "ArrowRight") {
                    event.preventDefault();
                    if (event.key === "ArrowLeft") {
                        goToSlide(currentIndex - 1);
                    } else {
                        goToSlide(currentIndex + 1);
                    }
                }
            };

            carousel.addEventListener("keydown", handleKeydown);
            carousel.addEventListener("mouseenter", stopAutoPlay);
            carousel.addEventListener("mouseleave", startAutoPlay);
            carousel.addEventListener("focusin", stopAutoPlay);
            carousel.addEventListener("focusout", startAutoPlay);

            document.addEventListener("visibilitychange", () => {
                if (document.hidden) {
                    stopAutoPlay();
                } else {
                    startAutoPlay();
                }
            });

            const handleTouchStart = (event) => {
                const touch = event.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
                isDragging = true;
                stopAutoPlay();
            };

            const handleTouchMove = (event) => {
                if (!isDragging) return;
                const touch = event.touches[0];
                const deltaX = Math.abs(touch.clientX - touchStartX);
                const deltaY = Math.abs(touch.clientY - touchStartY);
                const isHorizontal = deltaX > deltaY;
                if (isHorizontal) {
                    event.preventDefault();
                } else {
                    isDragging = false;
                    startAutoPlay();
                }
            };

            const handleTouchEnd = (event) => {
                if (!isDragging) return;
                isDragging = false;
                const endX = event.changedTouches[0].clientX;
                const diff = touchStartX - endX;
                if (Math.abs(diff) > 50) {
                    goToSlide(currentIndex + Math.sign(diff));
                }
                startAutoPlay();
            };

            track.addEventListener("touchstart", handleTouchStart, {
                passive: true,
            });
            track.addEventListener("touchmove", handleTouchMove, {
                passive: false,
            });
            track.addEventListener("touchend", handleTouchEnd, {
                passive: true,
            });

            window.addEventListener("resize", updateCarousel);
            const resizeObserver = new ResizeObserver(() =>
                requestAnimationFrame(() => {
                    updateCarousel();
                    startAutoPlay();
                }),
            );
            resizeObserver.observe(track);

            updateCarousel();
            startAutoPlay();
        };

        const mountCarousels = () => {
            document.querySelectorAll(carouselSelector).forEach((carousel) => {
                if (carousel.hasAttribute(readyAttr)) return;
                carousel.setAttribute(readyAttr, "true");
                initCarousel(carousel);
            });
        };

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", mountCarousels, {
                once: true,
            });
        } else {
            mountCarousels();
        }

        document.addEventListener("astro:after-swap", mountCarousels);
    })();
</script>
